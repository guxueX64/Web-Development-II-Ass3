<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Donation</title>
	<link href="css/detail.css" rel="stylesheet">
	<link href="css/share.css" rel="stylesheet">
</head>

<body>
	<!--Top navigation-->
	<div class="headr">
		<div class="heard-con">
			<img src="images/logo.jpg"
				style="margin-top: 7px;float: left;position: absolute;width: 60px;margin-top: 20px;">
			<div class="headr-nav">
				<ul>
					<li><a href="index.html">Home Page</span></a> </li>
					<li><a href="list.html">List Page</a>
					</li>
				</ul>
				<ul>
					<li><a href="#about">About Us</a></li>
					<li><a href="#contact">Contact Us</a></li>
					<li><a href="admin.html" style="color: #4AB344"><span style="color: #4AB344"></span>Admin Page</a></li>
				</ul>
			</div>
		</div>
	</div>

	<div class="content">
		<div class="cont-bot">
			<div class="hd" style="border: none;margin-bottom: 20px;">
				<ul>
					<li class="active" style="border: 1px  solid #D1D1D1;width: 100%;    text-align: left;">
						<div class="hd1 acti" style="width: 100%;">
						</div>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;action
					</li>
				</ul>
			</div>
			<div class="bd">
				<div class="rec-cot"
					style="border: none;height: 780px;border: 1px  solid #D1D1D1;border-radius: 10px;margin-bottom: 20px;">
					<div class="message">
						<p>image</p>
						<div class="siteFormMiddle" style="margin-bottom: 20px;">
							<input type="file" id="fimage"/><br/><br/>
							<input class="g_itext" type="text" placeholder="show image path" id="fundraiser_image" readonly
								autocomplete="off">
							<div class="star">*</div>
						</div>
						<p>organizer</p>
						<div class="siteFormMiddle" style="margin-bottom: 20px;">
							<input class="g_itext" type="text" placeholder="input organizer" id="organizer"
								autocomplete="off">
							<div class="star">*</div>
						</div>
						<p>caption</p>
						<div class="siteFormMiddle" style="margin-bottom: 20px;">
							<input class="g_itext" type="text" placeholder="input caption" id="caption"
								autocomplete="off">
							<div class="star">*</div>
						</div>
						<p>target funding</p>
						<div class="siteFormMiddle" style="margin-bottom: 20px;">
							<input class="g_itext" type="number" placeholder="input target funding" id="target_funding"
								autocomplete="off">
							<div class="star">*</div>
						</div>
						<p>city</p>
						<div class="siteFormMiddle" style="margin-bottom: 20px;">
							<select  class="resize" style="width: 50%;" id="city">
								<option value="Chicago">Chicago</option>
								<option value="Los Angeles">Los Angeles</option>
								<option value="Seattle">Seattle</option>
							</select>
							<div class="star">*</div>
						</div>
						<p>category</p>
						<div class="siteFormMiddle" style="margin-bottom: 20px;">
							<select  class="resize" style="width: 50%;" id="category_id">
								<option value="1">Medical</option>
								<option value="2">Memorial</option>
								<option value="3">Family</option>
							</select>
							<div class="star">*</div>
						</div>
						<p>Active</p>
						<div class="siteFormMiddle" style="margin-bottom: 20px;">
							<div class="siteFormItemCheck">
								<input type="radio" id="activeRadio1" name="active" value="1" checked>
								<label for="activeRadio1">yes</label>
							</div>
							<div class="siteFormItemCheck">
								<input type="radio" id="activeRadio" name="active" value="2">
								<label for="activeRadio">no</label>
							</div>
							<div class="star">*</div>
						</div>
						<div class="buttn" style="width: 50%;" onclick="saveData()">Submit</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		//Initialization function, executed during page loading
		init();
		//Responsible for obtaining URL parameters and initiating network requests, and then updating page content based on the request results
		function init() {
			//Create URL parameter object to obtain GET parameters
			let params = new URLSearchParams(window.location.search)
			if(parseInt( params.get("id")) == 0){
				return;
			}
			//Initiate a network request to obtain details page data
			fetch('detailSimple/' +params.get("id")).then(response => {
				//Check the network response status and throw an error if it is not normal
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				//Parse response to JSON format
				return response.json();
			}).then(res => {
				//Check the request status, if it is 200, update the page content
				if (res.status == 200) {
					//Traverse response data and update page element text content
					for (const key in res.data) {
						try{
							document.getElementById(key).value = res.data[key];
						}catch(e){}
						if(key == "active"){
							let activeRadio = document.getElementsByName("active");
							for(let i = 0; i < activeRadio.length; i++){
							    if (activeRadio[i].value == res.data[key]){
							        activeRadio[i].checked = true;
									break;
							    }
							}
						}
					}
				}
			}).catch(error => console.error('There was a problem with your fetch operation:', error));
		}

		//返回
		function goBack() {
			//Redirect to the list page
			window.location.href = 'admin.html'
		}


		//保存
		function saveData() {
			let params = new URLSearchParams(window.location.search)
			let fundraiser_id = parseInt(params.get("id"))
			let fundraiser_image = document.getElementById("fundraiser_image").value;
			let organizer = document.getElementById("organizer").value;
			let caption = document.getElementById("caption").value;
			let target_funding = document.getElementById("target_funding").value;
			let city = document.getElementById("city").value;
			let category_id = document.getElementById("category_id").value;
			//active
			var active = document.querySelectorAll('input[name="active"]:checked')[0].value
			if(organizer == "" || caption == "" || target_funding == "" || city == "" || category_id == "" || active.length == 0 || fundraiser_image == ''){
				alert("Please fill in all the information")
				return
			}
			if(fundraiser_id == 0){
				//Initiate a network request to obtain details page data
				fetch('fundraiserAdd', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						organizer: organizer,
						caption: caption,
						target_funding: target_funding,
						city:city,
						category_id:category_id,
						active:active,
						current_funding:0,
						fundraiser_image:fundraiser_image
					})
				}).then(response => {
					//Check the network response status and throw an error if it is not normal
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					//Parse response to JSON format
					return response.json();
				}).then(res => {
					console.log(res)
					if (res.status == 200) {
						alert("add success")
						goBack();
					}else{
						alert("add failed , try again")
					}
				})
			}else{
				fetch('fundraiserEdit', {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						organizer: organizer,
						caption: caption,
						target_funding: target_funding,
						city:city,
						category_id:category_id,
						active:active,
						fundraiser_id:fundraiser_id
					})
				}).then(response => {
					//Check the network response status and throw an error if it is not normal
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					//Parse response to JSON format
					return response.json();
				}).then(res => {
					console.log(res)
					if (res.status == 200) {
						alert("edit success")
						goBack();
					}else{
						alert("edit failed , try again")
					}
				})
			}
			
		}

		let fimage = document.getElementById('fimage')
        fimage.addEventListener('change', event => {
            let fileObj = fimage.files[0]
            if (fileObj) {
                let formData = new FormData()
                formData.append('image', fileObj)
                fetch('upload', {
					method: 'POST',
					body: formData
				}).then(response => {
					//Check the network response status and throw an error if it is not normal
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					//Parse response to JSON format
					return response.json();
				}).then(res => {
					fimage.value=''
					if (res.status == 200) {
						document.getElementById('fundraiser_image').value = res.data
					}else{
						alert("upload failed , try again")
					}
				})
			}
        })
	</script>
</body>

</html>
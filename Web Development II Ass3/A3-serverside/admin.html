<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Detail</title>
	<link href="css/detail.css" rel="stylesheet">
	<link href="css/share.css" rel="stylesheet">
	<style>.hd ul{float: left;}.hd li{float: left;}</style>
</head>

<body>
	<!--Top navigation-->
	<div class="headr">
		<div class="heard-con">
			<img src="images/logo.jpg" style="margin-top: 7px;float: left;position: absolute;width: 60px;margin-top: 20px;">
			<div class="headr-nav">
				<ul>
					<li><a href="index.html">Home Page</span></a> </li>
					<li><a href="list.html">List Page</span></a> </li>
				</ul>
				<ul>
                    <li><a href="#about">About Us</a></li>
                    <li><a href="#contact">Contact Us</a></li>
					<li><a href="admin.html" style="color: #4AB344"><span style="color: #4AB344"></span>Admin Page</a> </li>
                </ul>
			</div>
		</div>
	</div>
	<!--Top navigation-->

	<div class="content">
		<div class="buttn" onclick="goAction(0)">
			Insert New
		</div>
		<div class="sale">
			<ul class="sale-title">
				<li>caption(active)</li>
				<li>target/current</li>
				<li>organizer</li>
				<li>city</li>
				<li>action bar</li>
			</ul>
			<div id="every">

				
			</div>
		</div>
	</div>

	<script>
		//Initialization function, executed during page loading
		init();
		//Responsible for obtaining URL parameters and initiating network requests, and then updating page content based on the request results
		function init() {
			fetch('search').then(response => {
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				return response.json();
			})
			.then(res => {
				console.log(res)
				if (res.status == 200) {
					let array = res.data, str = ''
					if(array.length>0){
						for (let i = 0; i < array.length; i++) {
							str +=	`<ul class="sale-content">
								<li class='caption-line'>${array[i].caption}</li>
								<li class='caption-line'>${array[i].target_funding}/${array[i].current_funding}</li>
								<li class='caption-line'>${array[i].organizer}</li>
								<li class='caption-line'>${array[i].city}</li>
								<li class='caption-line'><span class='editspan' onclick='goAction(${array[i].fundraiser_id})'>Edit</span> <span class='deletespan'  onclick='goDelete(${array[i].fundraiser_id})'>Delete</span></li>
								</ul>`
						}
					}else{
						str="<p class='nodata'>no more data...</p>"
					}
					document.getElementById("every").innerHTML = str
				} else {
					alert(res.code)
				}
			})
			.catch(error => console.error('There was a problem with your fetch operation:', error));
		}

		function goAction(id){
		    window.location.href = "action.html?id=" + id
		}

		function goDelete(id){
			//删除前校验弹框
			if(confirm("Are you sure you want to delete this item?")){
					//Check if the fundraiser has donations, if it has, prompt the user to delete it
				fetch('detailSimple/' +id).then(response => {
					//Check the network response status and throw an error if it is not normal
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					//Parse response to JSON format
					return response.json();
				}).then(res => {
					//Check the request status, if it is 200, update the page content
					if (res.status == 200) {
						if(parseInt(res.data['current_funding'])>0){
							alert("Only fundraisers that do not have donations yet can be deleted")
							return
						}
						deleteData(id)
					}
				}).catch(error => console.error('There was a problem with your fetch operation:', error));
			}
		}

		function deleteData(id){
		    fetch('fundraiser/'+id, {
				method: 'DELETE'
			}).then(response => {
				//Check the network response status and throw an error if it is not normal
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				//Parse response to JSON format
				return response.json();
			}).then(res => {
				if (res.status == 200) {
					alert("delete success")
					window.location.reload()
				}else{
					alert("delete failed , try again")
				}
			})
		}
	</script>
</body>

</html>